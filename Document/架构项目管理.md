# 架构项目管理

主要对现在已有功能进行反思，思考优化路线，便于项目管理，同时记录一些灵感

## x. 未来的待优化任务（TODO LIST）

当前仅由我一人开发，所以暂时使用该文件进行项目管理。

若未来成立嵌入式组，该部分未来需要迁移到其他在线管理工具，比如飞书，规定好每个优化任务的负责人以及交付时间，自成一套项目管理体系。

### 任务优先级说明

A类，代表当下会对机器人运行或者重要开发任务造成影响的问题。

B类，代表当下不会对机器人运行造成影响，机器人能够实现基本功能，但是会一定程度上影响系统性能的问题。

C类，代表未来有必要新增的功能。

D类，代表不会对机器人运行造成任何影响，仅影响开发工作的问题，比如一些不合理的代码规划（小屎堆）或者架构设计缺陷等。

**后缀数字代表同类型问题下的优先级，数字越小优先级越高。**

下面是细则：

1. **A0**：**严重满足不了当下需求**，已经严重成为系统性能瓶颈了，需要立刻开始优化
2. **A1**：**在特定场景下会影响使用，但是可以通过其他方式规避的问题**，比如偶尔会触发，可以通过特定手段规避的BUG。这类问题通常**会给开发或者机器人运行造成不小的麻烦，增大了代码和机器人的维护成本**。需要在没有紧急任务的情况下开始优化。
3. **待完善，目前来看粗略的这样划分已经够用，其他类型或后缀优先级等待后人完善 —— 余浩**

### A类问题

#### 一、---CAN滤波器过滤性能缺陷

**问题1：**使用达妙CAN分析仪上位机，在上位机切换帧类型时，下位机会回显数个异常数据帧。

**问题2：**CAN过滤器选择仅过滤扩展帧时，无法筛除标准帧

**状态：**

1. **已解决**，联系了官方技术支持，确定异常数据帧是达妙上位机问题。
2. **已解决，**STM32底层 BSP适配问题

#### 二、---CAN状态管理无法触发CAN协议相关的错误计数

**问题：**当前基于STM32的CAN框架无法触发CAN协议规范的错误，导致相关计数器一直是0，可能和中断配置有关系？

**todo：**

排查BSP层错误处理相关的逻辑错误。深入学习STM32 CAN错误处理

**状态：**

**已解决，**是底层没有使能CAN_IT_LAST_ERROR_CODE。

### B类问题

#### 一、CAN总线对系统的性能影响

**问题：**为了确保读写操作的原子性，当前CAN总线的读写操作涉及到大量的开关中断操作，这在一定程度上影响到了系统的性能。

**todo：**

1. 发送处理：**典型的MPSC场景**，考虑引入无锁MPSC模型，降低开关中断的频率和时长。
   1. 思考：在CAN总线的架构设计中，充分考虑了CAN设备的状态检测和管理，在发送处理中，邮箱就充当着一个状态管理的角色，一方面通过管理邮箱状态，我们可以控制CAN的发送行为。另一方面，通过检测邮箱的状态，我们可以知道CAN控制器真实的邮箱状态如何。这样决定了邮箱实质上就是需要被各线程竞争的资源，当前架构引入了队列来避免各线程直接操作邮箱，从而绕过了计数信号量，试图提升性能。

2. 接收处理：**待构思**

#### 二、CAN总线的状态管理不完备

### C类问题

#### 一、CAN新增字节序配置项

**问题：**当前CAN框架只能先将数据传入以字节为单位、大小为8的数组，然后再进行发送。若是改用packed结构体、甚至是uint16_t都不行。输出是反序的，这可能跟大小端有关。

**思考：**STM32是**小端存储**，直接赋值操作，**数据高位对应地址高位，数据低位对应地址低位，而memcpy函数只是诚实地以首地址以字节为单位进行拷贝**。比如赋值0x15DF，15为数据高位，DF为数据低位，那么对应在地址中，DF在前，15在后（将uint16_t想象成一个2字节数组，下标0在前，实际上就是地址低位，对应数据DF，下标1在后，实际上是地址高位，对应数据15），因此在内存里的排序就是0xDF15。  因此拷贝时会出现反序。

**todo：**

为CAN报文加入大小端配置项，在框架层实现字节序矫正。

#### 二、高总线负载下，CAN架构中的紧急报文阻塞问题

**问题：**由于存在非破坏性仲裁，在CAN总线负载比较高的情况下，可能会导致低优先级的报文发不出去，一直处于待重传的状态。假设此时有一则紧急报文，如底盘断电或上电报文要发送，由于发送队列是一个FIFO结构，紧急报文必须等待低优先级的报文发送完成。这在某些情况下可能会导致意想不到的事故。

**todo：**

发送处理引入优先级队列，区分不同优先级报文，高优先级的报文先发送。优先级数量可静态配置。

#### 三、CAN框架引入同步发送机制

**问题：**CAN框架当前缺少一种同步发送机制以降低使用CAN驱动时的CPU负载，CPU要不异步轮询，要不通过回调的方式手动控制发送行为

**todo：**

引入完成量，实现同步发送机制

### D类问题

#### 一、宏观角度下的事件管理

**问题：**当前的回调处理（错误、读取、发送等）管理相当混乱，虽然统一使用device_xx_rb进行注册和触发，但是显而易见地，当触发的可能性多了起来之后（尤其是错误回调），会显得很混乱且容易导致出错，影响性能。(device_err_cb到处飞)。

**todo：**

考虑未来 引入新的依赖组件："事件-总线架构"，以统一管理回调的注册和触发方式



